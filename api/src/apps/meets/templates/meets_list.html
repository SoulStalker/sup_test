{% extends "base.html" %}

{% block content %}
{% load static %}

        <h1 class="text-2xl font-semibold mb-6">{% block title %}Таблица Meet{% endblock %}</h1>
        <div class="bg-white shadow rounded-lg">
            <!-- Поиск и элементы управления -->
            <div class="p-4 flex items-center space-x-4">
                <!-- Поиск -->
                <input type="text" placeholder="Поиск"
                       class="p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-teal-500 flex-grow mr-4">
                <div class="flex items-center space-x-2">
                    <div class="p-4 flex justify-center space-x-4">
                        <button id="style1-button"
                                class="bg-gray-200 p-2 rounded-lg text-[#FCFEFF] flex items-center justify-center hover:bg-gray-300 focus:outline-none active-button">
                            <svg width="28" height="16" viewBox="0 0 28 16" fill="none"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.16602 6.10352e-05H1.49935C1.03911 6.10352e-05 0.666016 0.358233 0.666016 0.800061V2.40006C0.666016 2.84189 1.03911 3.20006 1.49935 3.20006H3.16602C3.62625 3.20006 3.99935 2.84189 3.99935 2.40006V0.800061C3.99935 0.358233 3.62625 6.10352e-05 3.16602 6.10352e-05Z"
                                      fill="#40454D"/>
                                <path d="M3.16602 6.40006H1.49935C1.03911 6.40006 0.666016 6.75823 0.666016 7.20006V8.80006C0.666016 9.24189 1.03911 9.60006 1.49935 9.60006H3.16602C3.62625 9.60006 3.99935 9.24189 3.99935 8.80006V7.20006C3.99935 6.75823 3.62625 6.40006 3.16602 6.40006Z"
                                      fill="#40454D"/>
                                <path d="M3.16602 12.8001H1.49935C1.03911 12.8001 0.666016 13.1582 0.666016 13.6001V15.2001C0.666016 15.6419 1.03911 16.0001 1.49935 16.0001H3.16602C3.62625 16.0001 3.99935 15.6419 3.99935 15.2001V13.6001C3.99935 13.1582 3.62625 12.8001 3.16602 12.8001Z"
                                      fill="#40454D"/>
                                <path d="M25.666 3.20006H8.99935C8.55732 3.20006 8.1334 3.03149 7.82084 2.73143C7.50828 2.43137 7.33268 2.02441 7.33268 1.60006C7.33268 1.17571 7.50828 0.768749 7.82084 0.46869C8.1334 0.168632 8.55732 6.10352e-05 8.99935 6.10352e-05H25.666C26.108 6.10352e-05 26.532 0.168632 26.8445 0.46869C27.1571 0.768749 27.3327 1.17571 27.3327 1.60006C27.3327 2.02441 27.1571 2.43137 26.8445 2.73143C26.532 3.03149 26.108 3.20006 25.666 3.20006Z"
                                      fill="#40454D"/>
                                <path d="M25.666 9.60006H8.99935C8.55732 9.60006 8.1334 9.43149 7.82084 9.13143C7.50828 8.83137 7.33268 8.42441 7.33268 8.00006C7.33268 7.57571 7.50828 7.16875 7.82084 6.86869C8.1334 6.56863 8.55732 6.40006 8.99935 6.40006H25.666C26.108 6.40006 26.532 6.56863 26.8445 6.86869C27.1571 7.16875 27.3327 7.57571 27.3327 8.00006C27.3327 8.42441 27.1571 8.83137 26.8445 9.13143C26.532 9.43149 26.108 9.60006 25.666 9.60006Z"
                                      fill="#40454D"/>
                                <path d="M25.666 16.0001H8.99935C8.55732 16.0001 8.1334 15.8315 7.82084 15.5314C7.50828 15.2314 7.33268 14.8244 7.33268 14.4001C7.33268 13.9757 7.50828 13.5687 7.82084 13.2687C8.1334 12.9686 8.55732 12.8001 8.99935 12.8001H25.666C26.108 12.8001 26.532 12.9686 26.8445 13.2687C27.1571 13.5687 27.3327 13.9757 27.3327 14.4001C27.3327 14.8244 27.1571 15.2314 26.8445 15.5314C26.532 15.8315 26.108 16.0001 25.666 16.0001Z"
                                      fill="#40454D"/>
                            </svg>
                        </button>
                        <button id="style2-button"
                                class="bg-gray-200 p-2 rounded-lg inactive-button flex items-center justify-center hover:bg-gray-300 focus:outline-none">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path d="M23.999 4.79994C23.999 4.16342 23.7462 3.55297 23.2961 3.10288C22.846 2.6528 22.2355 2.39994 21.599 2.39994H19.199V1.19994C19.199 0.881679 19.0726 0.576454 18.8476 0.351411C18.6225 0.126367 18.3173 -6.10352e-05 17.999 -6.10352e-05C17.6808 -6.10352e-05 17.3755 0.126367 17.1505 0.351411C16.9255 0.576454 16.799 0.881679 16.799 1.19994V2.39994H13.199V1.19994C13.199 0.881679 13.0726 0.576454 12.8476 0.351411C12.6225 0.126367 12.3173 -6.10352e-05 11.999 -6.10352e-05C11.6808 -6.10352e-05 11.3755 0.126367 11.1505 0.351411C10.9255 0.576454 10.799 0.881679 10.799 1.19994V2.39994H7.19902V1.19994C7.19902 0.881679 7.0726 0.576454 6.84755 0.351411C6.62251 0.126367 6.31728 -6.10352e-05 5.99902 -6.10352e-05C5.68076 -6.10352e-05 5.37554 0.126367 5.1505 0.351411C4.92545 0.576454 4.79902 0.881679 4.79902 1.19994V2.39994H2.39902C1.7625 2.39994 1.15205 2.6528 0.701967 3.10288C0.25188 3.55297 -0.000976562 4.16342 -0.000976562 4.79994V7.19994H23.999V4.79994Z"
                                      fill="#FCFEFF"/>
                                <path d="M-0.000976562 21.5999C-0.000976562 22.2365 0.25188 22.8469 0.701967 23.297C1.15205 23.7471 1.7625 23.9999 2.39902 23.9999H21.599C22.2355 23.9999 22.846 23.7471 23.2961 23.297C23.7462 22.8469 23.999 22.2365 23.999 21.5999V9.59994H-0.000976562V21.5999ZM5.99902 11.9999H17.999C18.3173 11.9999 18.6225 12.1264 18.8476 12.3514C19.0726 12.5765 19.199 12.8817 19.199 13.1999C19.199 13.5182 19.0726 13.8234 18.8476 14.0485C18.6225 14.2735 18.3173 14.3999 17.999 14.3999H5.99902C5.68076 14.3999 5.37554 14.2735 5.1505 14.0485C4.92545 13.8234 4.79902 13.5182 4.79902 13.1999C4.79902 12.8817 4.92545 12.5765 5.1505 12.3514C5.37554 12.1264 5.68076 11.9999 5.99902 11.9999Z"
                                      fill="#FCFEFF"/>
                            </svg>
                        </button>
                    </div>
                    <select id="category-select"
                            class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-teal-500 focus:border-teal-500">
                        <option value="Категория">Категория</option>
                        {% for category in categories %}
                        <option value="{{ category.pk }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Элементы после кнопки "Меню таблицы" смещены вправо -->
                <div class="flex items-center ml-auto space-x-4">
                    <!-- Выпадающий список для количества строк -->
                    <form id="rows-per-page-form" method="get" class="flex items-center">
                        <label for="rows-per-page" class="mr-2 text-green-custom">Строк на странице:</label>
                        <select name="per_page" id="rows-per-page" class="p-2 border border-gray-300 rounded bg-green-custom text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="10" {% if request.GET.per_page == '10' %}selected{% endif %}>10</option>
                                <option value="20" {% if request.GET.per_page == '20' %}selected{% endif %}>20</option>
                                <option value="30" {% if request.GET.per_page == '30' %}selected{% endif %}>30</option>
                                <option value="50" {% if request.GET.per_page|default:'50' == '50' %}selected{% endif %}>50</option>
                                <option value="Все" {% if request.GET.per_page == 'Все' %}selected{% endif %}>Все</option>
                            </select>
                        <input type="hidden" name="page" value="{{ page.number }}">
                    </form>
                    {% include "pagination.html" with page=meets %}

                    <button id="open-modal" class="bg-green-custom text-white px-4 py-2 rounded hover:bg-green-dark">
                        Создать Meet
                    </button>
                </div>
            </div>
            <div id="table-container" class="overflow-x-auto lg:overflow-visible">
                <table id="table-style-1" class="w-full table-fixed mx-auto text-center">
                    <thead class="bg-gray-100 text-xs">
                    <tr>
                        <th class="border-b py-2 px-4 text-left w-1/12">ID</th>
                        <th class="border-b py-2 px-4 text-left w-2/12">Имя</th>
                        <th class="border-b py-2 px-4 text-left w-2/12">Фамилия</th>
                        <th class="border-b py-2 px-4 text-left w-2/12">Ник Telegram</th>
                        <th class="border-b py-2 px-4 text-left w-2/12">Имя Telegram</th>
                        {% for meet in meets %}
                        <th data-category="{{ meet.category_id }}"
                            class="border-b py-2 px-4 text-center font-semibold w-1/12">
                            {{ meet.start_time|date:"d.m." }}<br>{{ meet.start_time|date:"Y" }}
                        </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                    <tr class="hover:bg-gray-100">
                        <td class="border-b py-2 px-4 text-left">{{ user.id }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ user.name }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ user.surname }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ user.tg_nickname }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ user.tg_name }}</td>

                        {% for meet in meets %}
                        {% if user.id in meet.participant_statuses %}
                        <td data-category="{{ meet.category_id }}" class="border-b py-2 px-4 text-left">
                            {% for meet_id, status_color in user.meet_statuses.items %}
                            {% if meet_id == meet.id %}
                            <div class="w-6 h-6 mx-auto rounded-lg {% if status_color == 'red' %}bg-red-400 border border-red-800{% elif status_color == 'yellow' %}bg-yellow-200 border border-yellow-600{% else %}bg-green-400 border border-gray-600{% endif %}"></div>
                            {% endif %}
                            {% endfor %}
                        </td>
                        {% else %}
                        <td data-category="{{ meet.category_id }}" class="border-b py-2 px-4 text-left">
                            <div class="w-6 h-6 mx-auto rounded-lg bg-gray-200 border border-gray-600"></div>
                        </td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <table id="table-style-2" class="w-full table-fixed mx-auto hidden text-left">
                    <thead class="bg-gray-100 text-xs">
                    <tr>
                        <th class="border-b py-2 px-4 text-left" style="width: 30px;">ID</th>
                        <th class="border-b py-2 px-4 text-left w-9/12">Название</th>
                        <th class="border-b py-2 px-4 text-left w-2/12">Дата</th>
                        <th class="border-b py-2 px-4 text-right" style="width: 30px;"></th>
                        <th class="border-b py-2 px-4 text-right" style="width: 30px;"></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for meet in meets %}
                    <tr class="hover:bg-gray-100" data-category="{{ meet.category_id }}">
                        <td class="border-b py-2 px-4 text-left" style="width: 30px;">{{ meet.id }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ meet.title }}</td>
                        <td class="border-b py-2 px-4 text-left">{{ meet.start_time|date:"d.m.y" }}</td>
                        <td class="border-b py-2 px-4 text-right" style="width: 30px;">
                            <button class="text-red-600 hover:underline delete-btn" data-meet-id="{{ meet.id }}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                        <td class="border-b py-2 px-4 text-right" style="width: 30px;">
                            <button class="text-red-600 hover:underline edit-meet-button" data-meet-id="{{ meet.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
     </main>

    <!-- Модальное окно для Cоздать Meet -->
    <!-- Включаем модальное окно через include -->
    {% include 'create_meet_modal.html' %}
    <!-- Модальное окно для Cоздать категорию -->
    <!-- Включаем модальное окно через include -->
    {% include 'category_modal.html' %}

    <!-- Попап подтверждения удаления -->

    <div id="confirm-delete-popup" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg w-1/3">
            <h2 class="text-lg mb-4">Данный мит будет удален</h2>
            <div class="flex justify-end space-x-2">
                <button id="confirm-delete" type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Удалить</button>
                <button id="cancel-delete" type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700">Отмена</button>
            </div>
        </div>
    </div>
    <!-- Попап для отображения ошибки доступа -->
    <div id="access-denied-popup" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg w-1/3">
            <h2 class="text-lg mb-4" id="access-denied-message"></h2>
            <div class="flex justify-end">
                <button id="close-access-denied-popup" type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700">Закрыть</button>
            </div>
        </div>
    </div>

    <script src="{% static 'script/meets.js' %}"></script>
    <script src="{% static 'script/pagination.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.querySelector('input[type="text"]'); // Получаем поле поиска
            const tables = document.querySelectorAll('table tbody'); // Получаем тела всех таблиц
            const tableStyle1 = document.getElementById('table-style-1');
            const tableStyle2 = document.getElementById('table-style-2');

            // Создаем элемент для сообщения "Данные не найдены"
            const createNoDataMessage = (colSpan) => {
                const noDataMessage = document.createElement('tr');
                const noDataCell = document.createElement('td');
                noDataCell.colSpan = colSpan;
                noDataCell.textContent = 'Данные не найдены';
                noDataCell.classList.add('text-center', 'text-gray-500', 'py-4');
                noDataMessage.appendChild(noDataCell);
                return noDataMessage;
            };

            const highlightMatch = (text, query) => {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<span class="bg-yellow-200">$1</span>');
            };

            let noDataMessages = [];

            tables.forEach((tableBody) => {
                const colSpan = tableBody.closest('table').querySelectorAll('thead th').length;
                const noDataMessage = createNoDataMessage(colSpan);
                tableBody.appendChild(noDataMessage);
                noDataMessages.push(noDataMessage);
                noDataMessage.style.display = 'none'; // Изначально скрываем сообщение
            });

            // Обработчик ввода в поле поиска
            searchInput.addEventListener('input', function () {
                const query = searchInput.value.toLowerCase(); // Получаем строку поиска
                let foundInStyle1 = false;
                let foundInStyle2 = false;

                tables.forEach(function (tableBody, index) {
                    const rows = tableBody.querySelectorAll('tr:not(:last-child)'); // Получаем все строки таблицы, кроме сообщения "Данные не найдены"
                    let hasVisibleRows = false; // Отслеживаем, есть ли видимые строки

                    rows.forEach(function (row) {
                        const cells = row.querySelectorAll('td');
                        let match = false;

                        // Проверяем, есть ли совпадения в данных таблицы
                        cells.forEach(function (cell) {
                            const originalText = cell.textContent;
                            if (originalText.toLowerCase().includes(query)) {
                                match = true;
                                cell.innerHTML = highlightMatch(originalText, query);
                            } else {
                                cell.innerHTML = originalText; // Сбрасываем подсветку
                            }
                        });

                        // Если совпадение есть, показываем строку, иначе скрываем
                        if (match) {
                            row.style.display = '';
                            hasVisibleRows = true;
                            if (index === 0) foundInStyle1 = true; // Совпадение в таблице 1
                            if (index === 1) foundInStyle2 = true; // Совпадение в таблице 2
                        } else {
                            row.style.display = 'none';
                        }
                    });

                    // Если видимых строк нет, показываем сообщение "Данные не найдены"
                    if (!hasVisibleRows) {
                        noDataMessages[index].style.display = ''; // Показываем сообщение
                    } else {
                        noDataMessages[index].style.display = 'none'; // Скрываем сообщение
                    }
                });

                // Переключение вида таблицы на основе совпадений
                if (foundInStyle1) {
                    tableStyle1.classList.remove('hidden');
                    tableStyle2.classList.add('hidden');
                } else if (foundInStyle2) {
                    tableStyle2.classList.remove('hidden');
                    tableStyle1.classList.add('hidden');
                }
            });

            // Обработчик для очистки поля поиска (если потребуется сбросить фильтрацию)
            searchInput.addEventListener('blur', function () {
                if (searchInput.value === '') {
                    tables.forEach(function (tableBody, index) {
                        const rows = tableBody.querySelectorAll('tr:not(:last-child)');
                        rows.forEach(function (row) {
                            const cells = row.querySelectorAll('td');
                            cells.forEach(function (cell) {
                                cell.innerHTML = cell.textContent; // Сбрасываем подсветку
                            });
                            row.style.display = ''; // Показываем все строки
                        });

                        // Скрываем сообщение "Данные не найдены", если оно есть
                        noDataMessages[index].style.display = 'none';
                    });

                    // Сбрасываем таблицы к виду по умолчанию
                    tableStyle1.classList.remove('hidden');
                    tableStyle2.classList.add('hidden');
                }
            });
        });

    </script>
    {% block extra_js %}
    {% endblock %}

{% endblock %}